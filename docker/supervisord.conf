[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:postgresql]
command=/usr/lib/postgresql/14/bin/postgres -D /data/postgresql -c listen_addresses=127.0.0.1 -c port=5432
user=postgres
priority=10
autostart=true
autorestart=true
stdout_logfile=/var/log/postgresql.log
stderr_logfile=/var/log/postgresql_err.log

[program:redis]
command=redis-server --port 6379 --bind 127.0.0.1 --dir /data/redis --save ""
priority=20
autostart=true
autorestart=true
stdout_logfile=/var/log/redis.log
stderr_logfile=/var/log/redis_err.log

[program:backend]
command=python -m uvicorn app.main:app --host 127.0.0.1 --port 8000
directory=/app/backend
priority=40
autostart=true
autorestart=true
startsecs=5
stdout_logfile=/var/log/backend.log
stderr_logfile=/var/log/backend_err.log
environment=
    DATABASE_URL="postgresql+asyncpg://ocrcheck:ocrcheck@127.0.0.1:5432/ocrcheck",
    REDIS_URL="redis://127.0.0.1:6379/0",
    STORAGE_BACKEND="filesystem",
    UPLOAD_DIR="/data/uploads",
    SEARCH_BACKEND="postgresql"

[program:ocr-worker]
command=python -m app.workers.ocr_worker
directory=/app/backend
priority=50
autostart=true
autorestart=true
startsecs=5
stdout_logfile=/var/log/ocr_worker.log
stderr_logfile=/var/log/ocr_worker_err.log
environment=
    DATABASE_URL="postgresql+asyncpg://ocrcheck:ocrcheck@127.0.0.1:5432/ocrcheck",
    REDIS_URL="redis://127.0.0.1:6379/0",
    STORAGE_BACKEND="filesystem",
    UPLOAD_DIR="/data/uploads",
    SEARCH_BACKEND="postgresql"

[program:frontend]
command=node server.js
directory=/app/frontend
priority=60
autostart=true
autorestart=true
startsecs=3
stdout_logfile=/var/log/frontend.log
stderr_logfile=/var/log/frontend_err.log
environment=HOSTNAME="127.0.0.1",PORT="3000"

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
priority=70
autostart=true
autorestart=true
stdout_logfile=/var/log/nginx_access.log
stderr_logfile=/var/log/nginx_error.log
